AWSTemplateFormatVersion: '2010-09-09'

Description: 'Infraestructura WordPress con EC2, RDS MySQL, S3, NAT Gateway, CloudWatch Logs y ALB - AWS Academy Compatible'

Parameters:

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: vockey
    Description: Clave SSH para acceso a instancias

  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Contraseña para RDS MySQL (minimo 8 caracteres)
    Default: WordpressDB2026

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id
    Description: AMI Ubuntu 22.04 LTS

Resources:

  # ============================================
  # CLOUDWATCH LOG GROUP
  # ============================================

  EC2LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ec2/wordpress-instances
      RetentionInDays: 7

  # ============================================
  # VPC Y REDES
  # ============================================

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: WordPress-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: WordPress-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets Públicas
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-2

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-3

  # Subnets Privadas
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.5.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-2

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.6.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-3

  # NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: NAT-Gateway-EIP

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: WordPress-NAT-Gateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Public-Route-Table

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  # Route Table PRIVADA
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Private-Route-Table

  PrivateRoute:
    Type: AWS::EC2::Route
    DependsOn: NATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable

  # ============================================
  # SECURITY GROUPS
  # ============================================

  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Bastion-SG
      GroupDescription: Security group for Bastion Host
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH from anywhere
      Tags:
        - Key: Name
          Value: Bastion-SG

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: ALB-SG
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from Internet
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS from Internet
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: ALB-SG

  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: WebServer-SG
      GroupDescription: Security group for WordPress web servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB only
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: SSH from Bastion
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: WebServer-SG

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: RDS-SG
      GroupDescription: Security group for RDS MySQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: MySQL from Web Servers
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: MySQL from Bastion
      Tags:
        - Key: Name
          Value: RDS-SG

  # ============================================
  # S3 BUCKETS
  # ============================================

  WordPressUploadsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'wordpress-uploads-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      Tags:
        - Key: Name
          Value: WordPress-Uploads

  WordPressUploadsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WordPressUploadsBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub '${WordPressUploadsBucket.Arn}/*'

  BackupBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'wordpress-backups-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldBackups
            Status: Enabled
            ExpirationInDays: 30
      Tags:
        - Key: Name
          Value: WordPress-Backups

  # ============================================
  # RDS MYSQL
  # ============================================

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: wordpress-db-subnet-group
      DBSubnetGroupDescription: Subnet group for RDS in private subnets
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      Tags:
        - Key: Name
          Value: WordPress-DB-Subnet-Group

  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: wordpress-db
      DBName: wordpress
      Engine: mysql
      EngineVersion: '8.0.39'
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp2
      MasterUsername: admin
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: WordPress-RDS-MySQL

  # ============================================
  # BASTION HOST
  # ============================================

  BastionInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !Ref PublicSubnet1
          GroupSet:
            - !Ref BastionSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          apt-get update
          apt-get install -y mysql-client
          echo "Bastion configured" > /tmp/bastion-ready.txt
      Tags:
        - Key: Name
          Value: Bastion-Host

  # ============================================
  # APPLICATION LOAD BALANCER
  # ============================================

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn: AttachGateway
    Properties:
      Name: WordPress-ALB
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: WordPress-ALB

  WordPressTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: WordPress-TG
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /
      HealthCheckPort: traffic-port
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200,302
      Tags:
        - Key: Name
          Value: WordPress-TG

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WordPressTargetGroup

  # ============================================
  # EC2 WORDPRESS INSTANCES
  # ============================================

  WebServer1:
    Type: AWS::EC2::Instance
    DependsOn:
      - RDSInstance
      - NATGateway
      - EC2LogGroup
      - WordPressTargetGroup
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet1
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          LOG_GROUP="/ec2/wordpress-instances"
          REGION="${AWS::Region}"

          echo "=== Starting WordPress Server 1 ==="

          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "OK Internet connectivity"
          else
            echo "ERROR No Internet"
            exit 1
          fi

          apt-get update -y
          apt-get upgrade -y

          snap install amazon-ssm-agent --classic || true
          systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
          systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

          apt-get install -y apache2 php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip mysql-client awscli

          wget https://amazoncloudwatch-agent.s3.amazonaws.com/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb

          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOFCW
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/apache2/access.log",
                      "log_group_name": "$$LOG_GROUP",
                      "log_stream_name": "{instance_id}/apache2-access"
                    },
                    {
                      "file_path": "/var/log/apache2/error.log",
                      "log_group_name": "$$LOG_GROUP",
                      "log_stream_name": "{instance_id}/apache2-error"
                    }
                  ]
                }
              }
            }
          }
          EOFCW

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl             -a fetch-config             -m ec2             -s             -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

          cd /var/www/html
          rm -f index.html
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          mv wordpress/* .
          rm -rf wordpress latest.tar.gz

          cat > wp-config.php <<EOFWP
          <?php
          define('DB_NAME', 'wordpress');
          define('DB_USER', 'admin');
          define('DB_PASSWORD', '${DBPassword}');
          define('DB_HOST', '${RDSInstance.Endpoint.Address}');
          define('DB_CHARSET', 'utf8mb4');
          define('DB_COLLATE', '');

          define('AUTH_KEY',         'put your unique phrase here');
          define('SECURE_AUTH_KEY',  'put your unique phrase here');
          define('LOGGED_IN_KEY',    'put your unique phrase here');
          define('NONCE_KEY',        'put your unique phrase here');
          define('AUTH_SALT',        'put your unique phrase here');
          define('SECURE_AUTH_SALT', 'put your unique phrase here');
          define('LOGGED_IN_SALT',   'put your unique phrase here');
          define('NONCE_SALT',       'put your unique phrase here');

          \$table_prefix = 'wp_';

          define('WP_DEBUG', false);

          if ( ! defined( 'ABSPATH' ) ) {
            define( 'ABSPATH', __DIR__ . '/' );
          }

          require_once ABSPATH . 'wp-settings.php';
          EOFWP

          cat >> wp-config.php << 'EOFCONFIG'
          define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
          define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
          define('AS3CF_REGION', '${AWS::Region}');
          EOFCONFIG

          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html

          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          mv wp-cli.phar /usr/local/bin/wp

          cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
          <VirtualHost *:80>
            ServerAdmin webmaster@localhost
            DocumentRoot /var/www/html

            <Directory /var/www/html>
              Options FollowSymLinks
              AllowOverride All
              Require all granted
            </Directory>

            ErrorLog /var/log/apache2/error.log
            CustomLog /var/log/apache2/access.log combined
          </VirtualHost>
          EOFAPACHE

          a2ensite wordpress
          a2enmod rewrite
          systemctl restart apache2

          # Health check verification
          sleep 10
          HTTP_CODE=$$(curl -o /dev/null -s -w "%{http_code}" http://localhost/)
          if [ "$$HTTP_CODE" = "200" ] || [ "$$HTTP_CODE" = "302" ]; then
            echo "=== WordPress Server 1 ready - Health check OK (HTTP $$HTTP_CODE) ==="
          else
            echo "ERROR: Health check failed with HTTP $$HTTP_CODE"
            exit 1
          fi
      Tags:
        - Key: Name
          Value: WordPress-Server-1

  WebServer2:
    Type: AWS::EC2::Instance
    DependsOn:
      - RDSInstance
      - NATGateway
      - EC2LogGroup
      - WordPressTargetGroup
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          LOG_GROUP="/ec2/wordpress-instances"
          REGION="${AWS::Region}"

          echo "=== Starting WordPress Server 2 ==="

          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "OK Internet connectivity"
          else
            echo "ERROR No Internet"
            exit 1
          fi

          apt-get update -y
          apt-get upgrade -y

          snap install amazon-ssm-agent --classic || true
          systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
          systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

          apt-get install -y apache2 php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip mysql-client awscli

          wget https://amazoncloudwatch-agent.s3.amazonaws.com/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb

          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOFCW
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/apache2/access.log",
                      "log_group_name": "$$LOG_GROUP",
                      "log_stream_name": "{instance_id}/apache2-access"
                    },
                    {
                      "file_path": "/var/log/apache2/error.log",
                      "log_group_name": "$$LOG_GROUP",
                      "log_stream_name": "{instance_id}/apache2-error"
                    }
                  ]
                }
              }
            }
          }
          EOFCW

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl             -a fetch-config             -m ec2             -s             -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

          cd /var/www/html
          rm -f index.html
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          mv wordpress/* .
          rm -rf wordpress latest.tar.gz

          cat > wp-config.php <<EOFWP
          <?php
          define('DB_NAME', 'wordpress');
          define('DB_USER', 'admin');
          define('DB_PASSWORD', '${DBPassword}');
          define('DB_HOST', '${RDSInstance.Endpoint.Address}');
          define('DB_CHARSET', 'utf8mb4');
          define('DB_COLLATE', '');

          define('AUTH_KEY',         'put your unique phrase here');
          define('SECURE_AUTH_KEY',  'put your unique phrase here');
          define('LOGGED_IN_KEY',    'put your unique phrase here');
          define('NONCE_KEY',        'put your unique phrase here');
          define('AUTH_SALT',        'put your unique phrase here');
          define('SECURE_AUTH_SALT', 'put your unique phrase here');
          define('LOGGED_IN_SALT',   'put your unique phrase here');
          define('NONCE_SALT',       'put your unique phrase here');

          \$table_prefix = 'wp_';

          define('WP_DEBUG', false);

          if ( ! defined( 'ABSPATH' ) ) {
            define( 'ABSPATH', __DIR__ . '/' );
          }

          require_once ABSPATH . 'wp-settings.php';
          EOFWP

          cat >> wp-config.php << 'EOFCONFIG'
          define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
          define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
          define('AS3CF_REGION', '${AWS::Region}');
          EOFCONFIG

          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html

          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          mv wp-cli.phar /usr/local/bin/wp

          cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
          <VirtualHost *:80>
            ServerAdmin webmaster@localhost
            DocumentRoot /var/www/html

            <Directory /var/www/html>
              Options FollowSymLinks
              AllowOverride All
              Require all granted
            </Directory>

            ErrorLog /var/log/apache2/error.log
            CustomLog /var/log/apache2/access.log combined
          </VirtualHost>
          EOFAPACHE

          a2ensite wordpress
          a2enmod rewrite
          systemctl restart apache2

          # Health check verification
          sleep 10
          HTTP_CODE=$$(curl -o /dev/null -s -w "%{http_code}" http://localhost/)
          if [ "$$HTTP_CODE" = "200" ] || [ "$$HTTP_CODE" = "302" ]; then
            echo "=== WordPress Server 2 ready - Health check OK (HTTP $$HTTP_CODE) ==="
          else
            echo "ERROR: Health check failed with HTTP $$HTTP_CODE"
            exit 1
          fi
      Tags:
        - Key: Name
          Value: WordPress-Server-2

  WebServer3:
    Type: AWS::EC2::Instance
    DependsOn:
      - RDSInstance
      - NATGateway
      - EC2LogGroup
      - WordPressTargetGroup
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet3
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          LOG_GROUP="/ec2/wordpress-instances"
          REGION="${AWS::Region}"

          echo "=== Starting WordPress Server 3 ==="

          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "OK Internet connectivity"
          else
            echo "ERROR No Internet"
            exit 1
          fi

          apt-get update -y
          apt-get upgrade -y

          snap install amazon-ssm-agent --classic || true
          systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
          systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

          apt-get install -y apache2 php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip mysql-client awscli

          wget https://amazoncloudwatch-agent.s3.amazonaws.com/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb

          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOFCW
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/apache2/access.log",
                      "log_group_name": "$$LOG_GROUP",
                      "log_stream_name": "{instance_id}/apache2-access"
                    },
                    {
                      "file_path": "/var/log/apache2/error.log",
                      "log_group_name": "$$LOG_GROUP",
                      "log_stream_name": "{instance_id}/apache2-error"
                    }
                  ]
                }
              }
            }
          }
          EOFCW

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl             -a fetch-config             -m ec2             -s             -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

          cd /var/www/html
          rm -f index.html
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          mv wordpress/* .
          rm -rf wordpress latest.tar.gz

          cat > wp-config.php <<EOFWP
          <?php
          define('DB_NAME', 'wordpress');
          define('DB_USER', 'admin');
          define('DB_PASSWORD', '${DBPassword}');
          define('DB_HOST', '${RDSInstance.Endpoint.Address}');
          define('DB_CHARSET', 'utf8mb4');
          define('DB_COLLATE', '');

          define('AUTH_KEY',         'put your unique phrase here');
          define('SECURE_AUTH_KEY',  'put your unique phrase here');
          define('LOGGED_IN_KEY',    'put your unique phrase here');
          define('NONCE_KEY',        'put your unique phrase here');
          define('AUTH_SALT',        'put your unique phrase here');
          define('SECURE_AUTH_SALT', 'put your unique phrase here');
          define('LOGGED_IN_SALT',   'put your unique phrase here');
          define('NONCE_SALT',       'put your unique phrase here');

          \$table_prefix = 'wp_';

          define('WP_DEBUG', false);

          if ( ! defined( 'ABSPATH' ) ) {
            define( 'ABSPATH', __DIR__ . '/' );
          }

          require_once ABSPATH . 'wp-settings.php';
          EOFWP

          cat >> wp-config.php << 'EOFCONFIG'
          define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
          define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
          define('AS3CF_REGION', '${AWS::Region}');
          EOFCONFIG

          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html

          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          mv wp-cli.phar /usr/local/bin/wp

          cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
          <VirtualHost *:80>
            ServerAdmin webmaster@localhost
            DocumentRoot /var/www/html

            <Directory /var/www/html>
              Options FollowSymLinks
              AllowOverride All
              Require all granted
            </Directory>

            ErrorLog /var/log/apache2/error.log
            CustomLog /var/log/apache2/access.log combined
          </VirtualHost>
          EOFAPACHE

          a2ensite wordpress
          a2enmod rewrite
          systemctl restart apache2

          # Health check verification
          sleep 10
          HTTP_CODE=$$(curl -o /dev/null -s -w "%{http_code}" http://localhost/)
          if [ "$$HTTP_CODE" = "200" ] || [ "$$HTTP_CODE" = "302" ]; then
            echo "=== WordPress Server 3 ready - Health check OK (HTTP $$HTTP_CODE) ==="
          else
            echo "ERROR: Health check failed with HTTP $$HTTP_CODE"
            exit 1
          fi
      Tags:
        - Key: Name
          Value: WordPress-Server-3

  # ============================================
  # OUTPUTS
  # ============================================

Outputs:

  VPCId:
    Description: VPC ID
    Value: !Ref VPC

  NATGatewayIP:
    Description: NAT Gateway Elastic IP
    Value: !Ref NATGatewayEIP

  CloudWatchLogGroup:
    Description: CloudWatch Log Group
    Value: !Ref EC2LogGroup

  PublicSubnets:
    Description: Public Subnet IDs for ALB
    Value: !Sub '${PublicSubnet1},${PublicSubnet2},${PublicSubnet3}'

  BastionPublicIP:
    Description: Bastion Host Public IP
    Value: !GetAtt BastionInstance.PublicIp

  RDSEndpoint:
    Description: RDS Database Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address

  RDSPort:
    Description: RDS Database Port
    Value: !GetAtt RDSInstance.Endpoint.Port

  WordPressUploadsBucketName:
    Description: S3 Bucket for WordPress uploads
    Value: !Ref WordPressUploadsBucket

  BackupBucketName:
    Description: S3 Bucket for backups
    Value: !Ref BackupBucket

  WebServer1PrivateIP:
    Description: Web Server 1 Private IP
    Value: !GetAtt WebServer1.PrivateIp

  WebServer2PrivateIP:
    Description: Web Server 2 Private IP
    Value: !GetAtt WebServer2.PrivateIp

  WebServer3PrivateIP:
    Description: Web Server 3 Private IP
    Value: !GetAtt WebServer3.PrivateIp

  WebServer1InstanceId:
    Description: Web Server 1 Instance ID (para registrar en Target Group)
    Value: !Ref WebServer1

  WebServer2InstanceId:
    Description: Web Server 2 Instance ID (para registrar en Target Group)
    Value: !Ref WebServer2

  WebServer3InstanceId:
    Description: Web Server 3 Instance ID (para registrar en Target Group)
    Value: !Ref WebServer3

  WebServerSecurityGroup:
    Description: Web Server Security Group ID
    Value: !Ref WebServerSecurityGroup

  ALBSecurityGroup:
    Description: ALB Security Group ID
    Value: !Ref ALBSecurityGroup

  LoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-ALB-DNS'

  LoadBalancerURL:
    Description: URL to access WordPress via ALB
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'

  TargetGroupArn:
    Description: Target Group ARN
    Value: !Ref WordPressTargetGroup
