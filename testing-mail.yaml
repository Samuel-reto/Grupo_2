AWSTemplateFormatVersion: '2010-09-09'

Description: 'Infraestructura WordPress COMPLETA: RDS Proxy, WAF IP Whitelist, Auto Scaling, EFS, ALB, Lambda Backups'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Configuraci√≥n de Red y Seguridad"
        Parameters:
          - KeyName
          - AdminWhitelistIPs
      - Label:
          default: "Configuraci√≥n de Base de Datos"
        Parameters:
          - DBPassword
          - EnableRDSProxy
      - Label:
          default: "Configuraci√≥n de AMI"
        Parameters:
          - LatestAmiId
          - UseProductionAMI
          - ProductionAMI
      - Label:
          default: "Configuraci√≥n de Dominio"
        Parameters:
          - DomainName

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: vockey
    Description: Clave SSH para acceso a instancias

  AdminWhitelistIPs:
    Type: CommaDelimitedList
    Default: "0.0.0.0/0"
    Description: "IPs permitidas para wp-admin (ej: 203.0.113.10/32,198.51.100.5/32). Usa 0.0.0.0/0 para permitir todos"

  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Contrase√±a para RDS MySQL (minimo 8 caracteres)
    Default: WordpressDB2026

  EnableRDSProxy:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
    Description: "Activar RDS Proxy para mejor gesti√≥n de conexiones y escalabilidad"

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id
    Description: AMI Ubuntu 22.04 LTS

  UseProductionAMI:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: Cambiar a 'true' cuando tengas una AMI de produccion lista

  ProductionAMI:
    Type: String
    Description: AMI ID de WordPress configurado (dejar vacio hasta tener la AMI de produccion)
    Default: ""

  DomainName:
    Type: String
    Default: aglinformatica2.com.es
    Description: Nombre de dominio personalizado para WordPress
  
  MonitoringEmail:
    Type: String
    Description: Email para recibir reportes de monitoreo de WordPress
    Default: ""
    AllowedPattern: "^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    ConstraintDescription: Debe ser una direcci√≥n de email v√°lida o dejar vac√≠o

Conditions:
  UseProductionAMICondition: !Equals [!Ref UseProductionAMI, "true"]
  EnableRDSProxyCondition: !Equals [!Ref EnableRDSProxy, "true"]
  CreateMonitoringNotifications: !Not [!Equals [!Ref MonitoringEmail, ""]]
Resources:
  # ============================================
  # CLOUDWATCH LOG GROUP
  # ============================================
  EC2LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ec2/wordpress-instances
      RetentionInDays: 7

  # ============================================
  # VPC Y REDES
  # ============================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: WordPress-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: WordPress-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets P√∫blicas
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-2

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-3

  # Subnets Privadas
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.5.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-2

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.6.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-3

  # NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: NAT-Gateway-EIP

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: WordPress-NAT-Gateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Public-Route-Table

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  # Route Table PRIVADA
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Private-Route-Table

  PrivateRoute:
    Type: AWS::EC2::Route
    DependsOn: NATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable

  # ============================================
  # SECURITY GROUPS
  # ============================================
  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Bastion-SG
      GroupDescription: Security group for Bastion Host
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH from anywhere
      Tags:
        - Key: Name
          Value: Bastion-SG

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: ALB-SG
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from Internet
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS from Internet
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: ALB-SG

  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: WebServer-SG
      GroupDescription: Security group for WordPress web servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB only
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: SSH from Bastion
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: WebServer-SG

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: RDS-SG
      GroupDescription: Security group for RDS MySQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: MySQL from Web Servers
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: MySQL from Bastion
      Tags:
        - Key: Name
          Value: RDS-SG

  # RDS PROXY SECURITY GROUP
  RDSProxySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: EnableRDSProxyCondition
    Properties:
      GroupName: RDS-Proxy-SG
      GroupDescription: Security group for RDS Proxy
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: MySQL from Web Servers
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: MySQL from Bastion
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          DestinationSecurityGroupId: !Ref RDSSecurityGroup
          Description: MySQL to RDS
      Tags:
        - Key: Name
          Value: RDS-Proxy-SG

  # Permitir que RDS reciba conexiones desde RDS Proxy
  RDSSecurityGroupIngressFromProxy:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: EnableRDSProxyCondition
    Properties:
      GroupId: !Ref RDSSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref RDSProxySecurityGroup
      Description: MySQL from RDS Proxy

  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: EFS-SG
      GroupDescription: Security group for EFS Mount Targets
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: NFS from Web Servers
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: NFS from Bastion
      Tags:
        - Key: Name
          Value: EFS-SG

  # ============================================
  # EFS FILE SYSTEM
  # ============================================
  EFSFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      LifecyclePolicies:
        - TransitionToIA: AFTER_30_DAYS
      FileSystemTags:
        - Key: Name
          Value: WordPress-EFS

  EFSMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet1
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet2
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTarget3:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet3
      SecurityGroups:
        - !Ref EFSSecurityGroup

 # ============================================
# S3 BUCKETS
# ============================================
ReportsBucket:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: !Sub 'wordpress-reports-${AWS::AccountId}'
    VersioningConfiguration:
      Status: Enabled
    PublicAccessBlockConfiguration:
      BlockPublicAcls: false
      BlockPublicPolicy: false
      IgnorePublicAcls: false
      RestrictPublicBuckets: false
    Tags:
      - Key: Name
        Value: WordPress-Reports

ReportsBucketPolicy:
  Type: AWS::S3::BucketPolicy
  Properties:
    Bucket: !Ref ReportsBucket
    PolicyDocument:
      Statement:
        - Sid: PublicReadGetObject
          Effect: Allow
          Principal: '*'
          Action: 's3:GetObject'
          Resource: !Sub '${ReportsBucket.Arn}/*'

  # ============================================
  # SECRETS MANAGER PARA RDS PROXY
  # ============================================
  RDSSecret:
    Type: AWS::SecretsManager::Secret
    Condition: EnableRDSProxyCondition
    Properties:
      Name: !Sub '${AWS::StackName}-rds-credentials'
      Description: Credenciales RDS para WordPress con RDS Proxy
      SecretString: !Sub |
        {
          "username": "admin",
          "password": "${DBPassword}"
        }
      Tags:
        - Key: Name
          Value: RDS-Proxy-Credentials

  # ============================================
  # RDS MYSQL
  # ============================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: wordpress-db-subnet-group
      DBSubnetGroupDescription: Subnet group for RDS in private subnets
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      Tags:
        - Key: Name
          Value: WordPress-DB-Subnet-Group

  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: wordpress-db
      DBName: wordpress
      Engine: mysql
      EngineVersion: '8.0'
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp2
      MasterUsername: admin
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: WordPress-RDS-MySQL
        - Key: BackupType
          Value: automated

  # ============================================
  # RDS PROXY
  # ============================================
  RDSProxy:
    Type: AWS::RDS::DBProxy
    Condition: EnableRDSProxyCondition
    Properties:
      DBProxyName: !Sub '${AWS::StackName}-rds-proxy'
      EngineFamily: MYSQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !Ref RDSSecret
          IAMAuth: DISABLED
      RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
      VpcSubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      VpcSecurityGroupIds:
        - !Ref RDSProxySecurityGroup
      RequireTLS: false
      IdleClientTimeout: 1800
      Tags:
        - Key: Name
          Value: WordPress-RDS-Proxy

  RDSProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    Condition: EnableRDSProxyCondition
    Properties:
      DBProxyName: !Ref RDSProxy
      TargetGroupName: default
      DBInstanceIdentifiers:
        - !Ref RDSInstance
      ConnectionPoolConfigurationInfo:
        MaxConnectionsPercent: 100
        MaxIdleConnectionsPercent: 50
        ConnectionBorrowTimeout: 120

# ============================================
# BASTION HOST
# ============================================
BastionInstance:
  Type: AWS::EC2::Instance
  Properties:
    ImageId: !Ref LatestAmiId
    InstanceType: t2.micro
    KeyName: !Ref KeyName
    IamInstanceProfile: LabInstanceProfile
    NetworkInterfaces:
      - AssociatePublicIpAddress: true
        DeviceIndex: 0
        SubnetId: !Ref PublicSubnet1
        GroupSet:
          - !Ref BastionSecurityGroup
    UserData:
      Fn::Base64: !Sub |
        #!/bin/bash
        set -e

        echo "=== Configurando Bastion Host con PowerShell (AUTOMATIZADO) ==="
        date

        # Actualizar sistema
        apt-get update
        apt-get install -y mysql-client git awscli nfs-common curl jq

        # ============================================
        # INSTALAR POWERSHELL
        # ============================================
        echo "=== Instalando PowerShell ==="
        curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/powershell.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/powershell.gpg] https://packages.microsoft.com/ubuntu/22.04/prod jammy main" | tee /etc/apt/sources.list.d/microsoft-powershell.list
        apt-get update
        apt-get install -y powershell
        pwsh --version
        echo "‚úì PowerShell instalado correctamente"

        # ============================================
        # INSTALAR SSM AGENT
        # ============================================
        echo "=== Instalando SSM Agent ==="
        snap install amazon-ssm-agent --classic || true
        systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
        systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

        # ============================================
        # CONFIGURAR CLAVE SSH
        # ============================================
        echo "=== Configurando acceso SSH a instancias del ASG ==="
        mkdir -p /home/ubuntu/.ssh

        cat >> /home/ubuntu/.ssh/config << 'EOF'
        Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel ERROR
        EOF

        chown -R ubuntu:ubuntu /home/ubuntu/.ssh
        chmod 700 /home/ubuntu/.ssh
        chmod 600 /home/ubuntu/.ssh/config 2>/dev/null || true

        # ============================================
        # OBTENER SNS TOPIC ARN AUTOM√ÅTICAMENTE
        # ============================================
        echo "=== Obteniendo configuraci√≥n del stack ==="

        STACK_NAME="${AWS::StackName}"
        REGION="${AWS::Region}"

        # Esperar a que el stack est√© completamente creado
        sleep 30

        # Obtener el SNS Topic ARN desde los outputs del stack
        SNS_TOPIC_ARN=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region "$REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`MonitoringSNSTopicArn`].OutputValue' \
            --output text 2>/dev/null || echo "")

        if [ -z "$SNS_TOPIC_ARN" ] || [ "$SNS_TOPIC_ARN" == "None" ]; then
          echo "‚ö†Ô∏è  SNS Topic no configurado (no se proporcion√≥ email). Los reportes se guardar√°n localmente."
          SNS_TOPIC_ARN=""
        else
          echo "‚úì SNS Topic ARN obtenido: $SNS_TOPIC_ARN"
        fi

        # ============================================
        # OBTENER S3 BUCKET AUTOM√ÅTICAMENTE
        # ============================================
        S3_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region "$REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`WordPressUploadsBucketName`].OutputValue' \
            --output text 2>/dev/null || echo "")

        if [ -z "$S3_BUCKET" ] || [ "$S3_BUCKET" == "None" ]; then
          echo "‚ö†Ô∏è  S3 Bucket no encontrado en outputs"
          S3_BUCKET=""
        else
          echo "‚úì S3 Bucket obtenido: $S3_BUCKET"
        fi

        # ============================================
        # DESCARGAR SCRIPT DE MONITOREO DESDE GITHUB
        # ============================================
        echo "=== Descargando script de monitoreo desde GitHub ==="
        mkdir -p /opt/wordpress-monitor
        cd /opt/wordpress-monitor

        # Descargar script FINAL desde GitHub
        GITHUB_REPO="https://raw.githubusercontent.com/Samuel-reto/Grupo_2/main"
        curl -o Monitor-WordPressLogs-FINAL-CLEAN.ps1 "$GITHUB_REPO/Monitor-WordPressLogs-FINAL-CLEAN.ps1" || {
          echo "‚ö†Ô∏è  Error descargando script desde GitHub"
        }

        chmod +x Monitor-WordPressLogs-FINAL-CLEAN.ps1

        if [ -f "Monitor-WordPressLogs-FINAL-CLEAN.ps1" ]; then
          echo "‚úì Script de monitoreo descargado correctamente"
          ls -lh Monitor-WordPressLogs-FINAL-CLEAN.ps1
        fi

        # Crear directorio de logs
        mkdir -p /var/log
        touch /var/log/wordpress-monitor.log
        chown ubuntu:ubuntu /var/log/wordpress-monitor.log

        # ============================================
        # CONFIGURAR VARIABLES DE ENTORNO COMPLETAS
        # ============================================
        echo "=== Configurando variables de entorno ==="

        cat > /opt/wordpress-monitor/config.env << EOFCONFIG
        # Configuraci√≥n del monitor de WordPress (GENERADA AUTOM√ÅTICAMENTE)
        export AWS_REGION="$REGION"
        export ASG_NAME="WordPress-ASG"
        export SNS_TOPIC_ARN="$SNS_TOPIC_ARN"
        export S3_BUCKET="$S3_BUCKET"
        EOFCONFIG

        chown ubuntu:ubuntu /opt/wordpress-monitor/config.env

        echo "‚úì Configuraci√≥n guardada:"
        cat /opt/wordpress-monitor/config.env

        # ============================================
        # CONFIGURAR WRAPPER Y CRON JOB
        # ============================================
        echo "=== Configurando tarea CRON ==="

        cat > /opt/wordpress-monitor/run-monitor.sh << 'EOFWRAPPER'
        #!/bin/bash
        source /opt/wordpress-monitor/config.env 2>/dev/null || {
            echo "Error cargando config.env" >&2
            exit 1
        }
        echo "=== $(date) ===" >> /var/log/wordpress-monitor.log
        /usr/bin/pwsh /opt/wordpress-monitor/Monitor-WordPressLogs-FINAL-CLEAN.ps1 >> /var/log/wordpress-monitor.log 2>&1
        echo "$(date): Monitor ejecutado ‚úì" >> /var/log/wordpress-monitor-cron.log
        EOFWRAPPER

        chmod +x /opt/wordpress-monitor/run-monitor.sh
        chown ubuntu:ubuntu /opt/wordpress-monitor/run-monitor.sh

        # Configurar CRON
        (crontab -u ubuntu -l 2>/dev/null || true; echo "0 */6 * * * /opt/wordpress-monitor/run-monitor.sh >> /var/log/wordpress-monitor-cron.log 2>&1"; echo "0 8 * * * /opt/wordpress-monitor/run-monitor.sh >> /var/log/wordpress-monitor-cron.log 2>&1") | crontab -u ubuntu -

        echo "‚úì Tareas CRON configuradas (6h + 8AM)"

        # ============================================
        # PRUEBA INMEDIATA
        # ============================================
        echo "=== Ejecutando primera prueba ==="
        sleep 10
        sudo -u ubuntu /opt/wordpress-monitor/run-monitor.sh

        echo "üéâ BASTION CONFIGURADO COMPLETAMENTE - Monitoring activo!"
        EOFCONFIG


  # ============================================
  # APPLICATION LOAD BALANCER
  # ============================================
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn: AttachGateway
    Properties:
      Name: WordPress-ALB
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: WordPress-ALB

  WordPressTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: WordPress-TG
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /
      HealthCheckPort: traffic-port
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200,302
      Tags:
        - Key: Name
          Value: WordPress-TG

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301

  ALBListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    DependsOn:
      - SSLCertificate
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      SslPolicy: ELBSecurityPolicy-2016-08
      Certificates:
        - CertificateArn: !Ref SSLCertificate
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WordPressTargetGroup

  # ============================================
  # INSTANCIA INICIAL PARA CREAR AMI
  # ============================================
  InitialWebServer:
    Type: AWS::EC2::Instance
    DependsOn:
      - RDSInstance
      - NATGateway
      - EC2LogGroup
      - EFSMountTarget1
      - EFSMountTarget2
      - EFSMountTarget3
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet1
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub
          - |
            #!/bin/bash
            set -e
            exec > >(tee /var/log/user-data.log)
            exec 2>&1

            echo "=== Starting WordPress Initial Server Configuration with EFS ==="
            date

            if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
              echo "‚úì Internet connectivity OK"
            else
              echo "‚úó ERROR: No Internet connectivity"
              exit 1
            fi

            echo "=== Updating system packages ==="
            apt-get update -y
            apt-get upgrade -y

            echo "=== Installing SSM Agent ==="
            snap install amazon-ssm-agent --classic || true
            systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
            systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

            echo "=== Installing required packages ==="
            apt-get install -y apache2 php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip mysql-client awscli git nfs-common

            echo "=== Creating WordPress directory ==="
            mkdir -p /var/www/html

            echo "=== Mounting EFS to /var/www/html using NFS4 ==="
            mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport ${EFSFileSystem}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html

            echo "=== Adding EFS to /etc/fstab for persistent mount ==="
            echo "${EFSFileSystem}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport,_netdev 0 0" >> /etc/fstab

            echo "=== Verifying EFS mount ==="
            df -h | grep efs
            ls -la /var/www/html/

            echo "=== Installing WordPress directly on EFS ==="
            cd /tmp
            wget https://wordpress.org/latest.tar.gz
            tar -xzf latest.tar.gz

            echo "=== Copying WordPress files to EFS-mounted /var/www/html ==="
            cp -r wordpress/* /var/www/html/
            rm -f /var/www/html/index.html

            echo "=== Configuring WordPress wp-config.php ==="
            cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
            sed -i "s/database_name_here/wordpress/" /var/www/html/wp-config.php
            sed -i "s/username_here/admin/" /var/www/html/wp-config.php
            sed -i "s/password_here/${DBPassword}/" /var/www/html/wp-config.php
            sed -i "s/localhost/${DatabaseEndpoint}/" /var/www/html/wp-config.php

            echo "=== Adding WordPress salt keys ==="
            curl -s https://api.wordpress.org/secret-key/1.1/salt/ >> /tmp/wp-keys.txt
            sed -i '/AUTH_KEY/,/NONCE_SALT/d' /var/www/html/wp-config.php
            sed -i "/DB_COLLATE/r /tmp/wp-keys.txt" /var/www/html/wp-config.php

            echo "=== Adding HTTPS configuration before stop editing comment ==="
            sed -i "/\/\* That's all, stop editing! Happy publishing. \*\//i\\n\// Configuraci√≥n HTTPS detr√°s de ALB\nif (isset(\\$_SERVER['HTTP_X_FORWARDED_PROTO']) && \\$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {\n    \\$_SERVER['HTTPS'] = 'on';\n}\ndefine('WP_HOME', 'https://www.aglinformatica2.com.es');\ndefine('WP_SITEURL', 'https://www.aglinformatica2.com.es');\ndefine('FORCE_SSL_ADMIN', true);\n" /var/www/html/wp-config.php

            echo "=== Adding S3 configuration ==="
            cat >> /var/www/html/wp-config.php << 'EOFS3'
            define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
            define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
            define('AS3CF_REGION', '${AWS::Region}');
            EOFS3

            echo "=== Cloning GitHub repository to EFS ==="
            cd /var/www/html/wp-content/themes/
            git clone https://github.com/Samuel-reto/Grupo_2.git health2you || echo "Git clone failed"

            if [ -d "health2you" ]; then
              echo "‚úì Repository cloned successfully to /var/www/html/wp-content/themes/health2you"
              ls -la health2you/ | head -10
            else
              echo "‚úó WARNING: Repository not cloned"
            fi

            echo "=== Creating Health2You database ==="
            mysql -h ${DatabaseEndpoint} -u admin -p${DBPassword} << EOSQL
            CREATE DATABASE IF NOT EXISTS health2you CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            SHOW DATABASES;
            EOSQL

            if [ -f "/var/www/html/wp-content/themes/health2you/health2you.sql" ]; then
              echo "=== Importing Health2You database schema ==="
              mysql -h ${DatabaseEndpoint} -u admin -p${DBPassword} health2you < /var/www/html/wp-content/themes/health2you/health2you.sql
              echo "‚úì Database schema imported successfully"
            else
              echo "‚ö† SQL file not found, skipping database import"
            fi

            if [ -f "/var/www/html/wp-content/themes/health2you/config.php" ]; then
              echo "=== Updating Health2You config.php with RDS credentials ==="
              sed -i "s/localhost/${DatabaseEndpoint}/" /var/www/html/wp-content/themes/health2you/config.php
              echo "‚úì Config.php updated"
            fi

            echo "=== Setting proper permissions for www-data ==="
            chown -R www-data:www-data /var/www/html
            chmod -R 755 /var/www/html

            echo "=== Configuring Apache ==="
            cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
            <VirtualHost *:80>
                ServerAdmin webmaster@localhost
                DocumentRoot /var/www/html
                <Directory /var/www/html>
                    Options FollowSymLinks
                    AllowOverride All
                    Require all granted
                </Directory>
                ErrorLog /var/log/apache2/error.log
                CustomLog /var/log/apache2/access.log combined
            </VirtualHost>
            EOFAPACHE

            a2ensite wordpress
            a2dissite 000-default
            a2enmod rewrite
            systemctl restart apache2

            echo "=== Performing health check ==="
            sleep 10
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost/)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "‚úì WordPress is ready - HTTP $HTTP_CODE"
            else
              echo "‚ö† WARNING: Unexpected HTTP code $HTTP_CODE"
            fi

            echo "=== EFS Status ==="
            df -h /var/www/html

            echo "=== WordPress files on EFS ==="
            ls -la /var/www/html/ | head -20

            echo "=== GitHub repository on EFS ==="
            ls -la /var/www/html/wp-content/themes/health2you/ | head -20

            echo "=== Initial Server Configuration Complete ===="
            date
          - DatabaseEndpoint: !If
              - EnableRDSProxyCondition
              - !GetAtt RDSProxy.Endpoint
              - !GetAtt RDSInstance.Endpoint.Address
      Tags:
        - Key: Name
          Value: WordPress-Initial-Server
        - Key: Purpose
          Value: CreateAMI

  # ============================================
  # LAUNCH TEMPLATE PARA AUTO SCALING
  # ============================================
  WebServerLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: WordPress-Launch-Template
      LaunchTemplateData:
        ImageId: !If
          - UseProductionAMICondition
          - !Ref ProductionAMI
          - !Ref LatestAmiId
        InstanceType: t2.micro
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Name: LabInstanceProfile
        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            exec > >(tee /var/log/user-data.log)
            exec 2>&1

            echo "=== Starting Auto Scaling Instance Configuration ==="
            date

            if [ ! -f /var/www/html/wp-config.php ]; then
              echo "=== MODE: Base AMI - Full installation with EFS mount ==="

              apt-get update -y
              snap install amazon-ssm-agent --classic || true
              systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
              systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

              apt-get install -y apache2 php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip mysql-client awscli git nfs-common

              mkdir -p /var/www/html
              mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport ${EFSFileSystem}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html
              echo "${EFSFileSystem}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport,_netdev 0 0" >> /etc/fstab

              if [ ! -f /var/www/html/wp-config.php ]; then
                cd /tmp
                wget https://wordpress.org/latest.tar.gz
                tar -xzf latest.tar.gz
                cp -r wordpress/* /var/www/html/
                rm -f /var/www/html/index.html

                cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
                sed -i "s/database_name_here/wordpress/" /var/www/html/wp-config.php
                sed -i "s/username_here/admin/" /var/www/html/wp-config.php
                sed -i "s/password_here/${DBPassword}/" /var/www/html/wp-config.php
                sed -i "s/localhost/${RDSInstance.Endpoint.Address}/" /var/www/html/wp-config.php

                curl -s https://api.wordpress.org/secret-key/1.1/salt/ >> /tmp/wp-keys.txt
                sed -i '/AUTH_KEY/,/NONCE_SALT/d' /var/www/html/wp-config.php
                sed -i "/DB_COLLATE/r /tmp/wp-keys.txt" /var/www/html/wp-config.php

                sed -i "/\/\* That's all, stop editing! Happy publishing. \*\//i\\n\// Configuraci√≥n HTTPS detr√°s de ALB\nif (isset(\\$_SERVER['HTTP_X_FORWARDED_PROTO']) && \\$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {\n    \\$_SERVER['HTTPS'] = 'on';\n}\ndefine('WP_HOME', 'https://www.aglinformatica2.com.es');\ndefine('WP_SITEURL', 'https://www.aglinformatica2.com.es');\ndefine('FORCE_SSL_ADMIN', true);\n" /var/www/html/wp-config.php

                cat >> /var/www/html/wp-config.php << 'EOFS3'
            define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
            define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
            define('AS3CF_REGION', '${AWS::Region}');
            EOFS3

                cd /var/www/html/wp-content/themes/
                git clone https://github.com/Samuel-reto/Grupo_2.git health2you || true

                if [ -f "/var/www/html/wp-content/themes/health2you/health2you.sql" ]; then
                  mysql -h ${RDSInstance.Endpoint.Address} -u admin -p${DBPassword} << EOSQL
            CREATE DATABASE IF NOT EXISTS health2you CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            EOSQL
                  mysql -h ${RDSInstance.Endpoint.Address} -u admin -p${DBPassword} health2you < /var/www/html/wp-content/themes/health2you/health2you.sql || true
                fi

                if [ -f "/var/www/html/wp-content/themes/health2you/config.php" ]; then
                  sed -i "s/localhost/${RDSInstance.Endpoint.Address}/" /var/www/html/wp-content/themes/health2you/config.php
                fi

                chown -R www-data:www-data /var/www/html
                chmod -R 755 /var/www/html
              fi

              cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
            <VirtualHost *:80>
                ServerAdmin webmaster@localhost
                DocumentRoot /var/www/html
                <Directory /var/www/html>
                    Options FollowSymLinks
                    AllowOverride All
                    Require all granted
                </Directory>
                ErrorLog /var/log/apache2/error.log
                CustomLog /var/log/apache2/access.log combined
            </VirtualHost>
            EOFAPACHE

              a2ensite wordpress
              a2dissite 000-default
              a2enmod rewrite
              systemctl restart apache2

            else
              echo "=== MODE: Production AMI - WordPress already exists on EFS ==="
              if ! mountpoint -q /var/www/html; then
                echo "Mounting EFS..."
                mount -a
              fi
              systemctl restart apache2
              systemctl restart snap.amazon-ssm-agent.amazon-ssm-agent.service || true
            fi

            sleep 10
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost/)
            echo "Health check: HTTP $HTTP_CODE"

            echo "=== Auto Scaling Instance Ready ==="
            date
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: WordPress-ASG-Instance
              - Key: AMIType
                Value: !If [UseProductionAMICondition, "production", "base"]

  # ============================================
  # AUTO SCALING GROUP
  # ============================================
  WebServerAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
      - ApplicationLoadBalancer
      - WordPressTargetGroup
    Properties:
      AutoScalingGroupName: WordPress-ASG
      LaunchTemplate:
        LaunchTemplateId: !Ref WebServerLaunchTemplate
        Version: !GetAtt WebServerLaunchTemplate.LatestVersionNumber
      MinSize: 2
      MaxSize: 6
      DesiredCapacity: 3
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      TargetGroupARNs:
        - !Ref WordPressTargetGroup
      Tags:
        - Key: Name
          Value: WordPress-ASG-Instance
          PropagateAtLaunch: true

  # ============================================
  # LAMBDA FUNCTION PARA BACKUPS
  # ============================================
  BackupLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: WordPress-Unified-Backup
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
      Timeout: 600
      Environment:
        Variables:
          EFS_ID: !Ref EFSFileSystem
          RDS_INSTANCE_ID: !Ref RDSInstance
          ASG_NAME: !Ref WebServerAutoScalingGroup
          RETENTION_DAYS: '7'
      Code:
        ZipFile: |
          import json
          import boto3
          from datetime import datetime, timedelta
          import os

          rds = boto3.client('rds')
          ec2 = boto3.client('ec2')
          efs_client = boto3.client('efs')
          asg = boto3.client('autoscaling')

          def lambda_handler(event, context):
              EFS_ID = os.environ['EFS_ID']
              RDS_INSTANCE_ID = os.environ['RDS_INSTANCE_ID']
              ASG_NAME = os.environ['ASG_NAME']
              RETENTION_DAYS = int(os.environ.get('RETENTION_DAYS', 7))

              timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')
              results = {'efs': {}, 'rds': {}, 'ec2': {}}

              print("INICIANDO BACKUP")

              # Backup EFS
              try:
                  response = efs_client.create_backup(FileSystemId=EFS_ID)
                  results['efs'] = {'success': True, 'id': response['BackupId']}
                  print(f"EFS OK: {response['BackupId']}")
              except Exception as e:
                  results['efs'] = {'success': False, 'error': str(e)}
                  print(f"EFS ERROR: {e}")

              # Backup RDS
              try:
                  snapshot_id = f"{RDS_INSTANCE_ID}-{timestamp}"
                  rds.create_db_snapshot(
                      DBSnapshotIdentifier=snapshot_id,
                      DBInstanceIdentifier=RDS_INSTANCE_ID,
                      Tags=[
                          {'Key': 'BackupType', 'Value': 'automated'},
                          {'Key': 'Timestamp', 'Value': timestamp}
                      ]
                  )
                  results['rds'] = {'success': True, 'id': snapshot_id}
                  print(f"RDS OK: {snapshot_id}")
              except Exception as e:
                  results['rds'] = {'success': False, 'error': str(e)}
                  print(f"RDS ERROR: {e}")

              # Backup EC2 - Obtener instancias del ASG din√°micamente
              ami_count = 0
              try:
                  asg_response = asg.describe_auto_scaling_groups(
                      AutoScalingGroupNames=[ASG_NAME]
                  )

                  if asg_response['AutoScalingGroups']:
                      instances = asg_response['AutoScalingGroups'][0]['Instances']
                      instance_ids = [i['InstanceId'] for i in instances if i['LifecycleState'] == 'InService']
                      print(f"Instancias encontradas en ASG: {instance_ids}")

                      for instance_id in instance_ids:
                          try:
                              ami_name = f"backup-{instance_id}-{timestamp}"
                              response = ec2.create_image(
                                  InstanceId=instance_id,
                                  Name=ami_name,
                                  NoReboot=True,
                                  TagSpecifications=[{
                                      'ResourceType': 'image',
                                      'Tags': [
                                          {'Key': 'Name', 'Value': ami_name},
                                          {'Key': 'BackupType', 'Value': 'automated'},
                                          {'Key': 'Timestamp', 'Value': timestamp}
                                      ]
                                  }]
                              )
                              ami_count += 1
                              print(f"EC2 OK: {response['ImageId']} from {instance_id}")
                          except Exception as e:
                              print(f"EC2 ERROR {instance_id}: {e}")

                      results['ec2'] = {'success': ami_count > 0, 'count': ami_count}
              except Exception as e:
                  results['ec2'] = {'success': False, 'error': str(e)}
                  print(f"ASG ERROR: {e}")

              # Limpieza de backups antiguos
              cleanup_old_backups(RDS_INSTANCE_ID, RETENTION_DAYS)

              print(f"\nRESUMEN: EFS={results['efs'].get('success')}, RDS={results['rds'].get('success')}, EC2={ami_count} AMIs")

              return {
                  'statusCode': 200,
                  'body': json.dumps(results, default=str)
              }

          def cleanup_old_backups(rds_instance_id, retention_days):
              cutoff_date = datetime.now() - timedelta(days=retention_days)
              try:
                  snapshots = rds.describe_db_snapshots(
                      DBInstanceIdentifier=rds_instance_id,
                      SnapshotType='manual'
                  )['DBSnapshots']

                  for snapshot in snapshots:
                      if snapshot['SnapshotCreateTime'].replace(tzinfo=None) < cutoff_date:
                          try:
                              rds.delete_db_snapshot(
                                  DBSnapshotIdentifier=snapshot['DBSnapshotIdentifier']
                              )
                              print(f"Eliminado snapshot antiguo: {snapshot['DBSnapshotIdentifier']}")
                          except Exception as e:
                              print(f"Error eliminando snapshot: {e}")
              except Exception as e:
                  print(f"Error en limpieza: {e}")

  BackupScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: WordPress-Daily-Backup
      Description: Backup diario a las 3:00 AM UTC
      ScheduleExpression: 'cron(0 3 * * ? *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt BackupLambdaFunction.Arn
          Id: BackupLambdaTarget

  BackupLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref BackupLambdaFunction
      Action: 'lambda:InvokeFunction'
      Principal: events.amazonaws.com
      SourceArn: !GetAtt BackupScheduleRule.Arn

  # ============================================
  # AWS WAFv2 CON IP WHITELIST PARA WP-ADMIN
  # ============================================
  AdminIPSet:
    Type: AWS::WAFv2::IPSet
    Properties:
      Name: !Sub '${AWS::StackName}-AdminWhitelist'
      Scope: REGIONAL
      IPAddressVersion: IPV4
      Addresses: !Ref AdminWhitelistIPs
      Description: IPs permitidas para acceder a wp-admin
      Tags:
        - Key: Name
          Value: WordPress-Admin-Whitelist

  WAFWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub '${AWS::StackName}-WAF'
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: WordPressWebACL
      Rules:
        - Name: AllowWpAdminFromTrustedIPs
          Priority: 1
          Statement:
            AndStatement:
              Statements:
                - ByteMatchStatement:
                    SearchString: "/wp-admin/"
                    FieldToMatch:
                      UriPath: {}
                    TextTransformations:
                      - Priority: 0
                        Type: NONE
                    PositionalConstraint: CONTAINS
                - IPSetReferenceStatement:
                    Arn: !GetAtt AdminIPSet.Arn
          Action:
            Allow: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AllowWpAdminFromTrustedIPs

        - Name: WordPressAppRules
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesWordPressRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: WordPressAppRules

        - Name: SQLiRules
          Priority: 3
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: SQLiRules

        - Name: XSSRules
          Priority: 4
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: XSSRules

        - Name: PHPAppRules
          Priority: 5
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesPHPRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: PHPAppRules

        - Name: RateLimitLogin
          Priority: 6
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 100
              EvaluationWindowSec: 300
              AggregateKeyType: IP
              ScopeDownStatement:
                ByteMatchStatement:
                  SearchString: "wp-login.php"
                  FieldToMatch:
                    UriPath: {}
                  TextTransformations:
                    - Priority: 0
                      Type: LOWERCASE
                  PositionalConstraint: CONTAINS
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitLogin

        - Name: RateLimitXMLRPC
          Priority: 7
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 50
              EvaluationWindowSec: 300
              AggregateKeyType: IP
              ScopeDownStatement:
                ByteMatchStatement:
                  SearchString: "xmlrpc.php"
                  FieldToMatch:
                    UriPath: {}
                  TextTransformations:
                    - Priority: 0
                      Type: LOWERCASE
                  PositionalConstraint: CONTAINS
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitXMLRPC

        - Name: BlockWpAdminForEveryoneElse
          Priority: 8
          Statement:
            ByteMatchStatement:
              SearchString: "/wp-admin/"
              FieldToMatch:
                UriPath: {}
              TextTransformations:
                - Priority: 0
                  Type: NONE
              PositionalConstraint: CONTAINS
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: BlockWpAdminForEveryoneElse

  WAFAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    DependsOn:
      - ApplicationLoadBalancer
      - WAFWebACL
    Properties:
      ResourceArn: !Ref ApplicationLoadBalancer
      WebACLArn: !GetAtt WAFWebACL.Arn

  # ============================================
  # ACM Certificate (Validaci√≥n DNS MANUAL)
  # ============================================
  SSLCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref DomainName
      SubjectAlternativeNames:
        - !Sub 'www.${DomainName}'
      ValidationMethod: DNS
      Tags:
        - Key: Name
          Value: WordPress-SSL-Certificate
  
 # ============================================
  # SNS TOPIC PARA MONITOREO DE WORDPRESS
  # ============================================
  MonitoringSNSTopic:
    Type: AWS::SNS::Topic
    Condition: CreateMonitoringNotifications
    Properties:
      TopicName: !Sub '${AWS::StackName}-WordPress-Monitoring'
      DisplayName: WordPress Monitoring Alerts
      Tags:
        - Key: Name
          Value: WordPress-Monitoring-Topic

  MonitoringEmailSubscription:
    Type: AWS::SNS::Subscription
    Condition: CreateMonitoringNotifications
    Properties:
      Protocol: email
      TopicArn: !Ref MonitoringSNSTopic
      Endpoint: !Ref MonitoringEmail

  # ============================================
  # OUTPUTS
  # ============================================
Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC

  LoadBalancerURL:
    Description: URL del Application Load Balancer
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'

  LoadBalancerDNS:
    Description: DNS del ALB para configurar CNAME
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  BastionPublicIP:
    Description: IP p√∫blica del Bastion Host
    Value: !GetAtt BastionInstance.PublicIp

  SSHConnectionCommand:
    Description: Comando para conectarse al Bastion
    Value: !Sub 'ssh -i vockey.pem ubuntu@${BastionInstance.PublicIp}'

  RDSEndpoint:
    Description: Endpoint directo de RDS MySQL
    Value: !GetAtt RDSInstance.Endpoint.Address

  RDSProxyEndpoint:
    Condition: EnableRDSProxyCondition
    Description: Endpoint de RDS Proxy (RECOMENDADO para WordPress)
    Value: !GetAtt RDSProxy.Endpoint

  DatabaseEndpointUsed:
    Description: Endpoint que est√° usando WordPress actualmente
    Value: !If
      - EnableRDSProxyCondition
      - !Sub '${RDSProxy.Endpoint} (RDS Proxy ACTIVADO)'
      - !Sub '${RDSInstance.Endpoint.Address} (RDS Directo)'

  RDSProxyStatus:
    Description: Estado del RDS Proxy
    Value: !If
      - EnableRDSProxyCondition
      - '‚úÖ ACTIVADO - WordPress usa conexi√≥n pooling para mejor rendimiento'
      - '‚ùå DESACTIVADO - WordPress se conecta directamente a RDS'

  EFSFileSystemId:
    Description: ID del sistema de archivos EFS
    Value: !Ref EFSFileSystem

  EFSMountCommand:
    Description: Comando para montar EFS manualmente
    Value: !Sub 'sudo mount -t nfs4 -o nfsvers=4.1 ${EFSFileSystem}.efs.${AWS::Region}.amazonaws.com:/ /var/www/html'

  ReportsBucketName:
  Description: S3 Bucket para reportes de WordPress
  Value: !Ref ReportsBucket

  BackupBucket:
    Description: S3 Bucket para backups
    Value: !Ref BackupBucket

  AutoScalingGroupName:
    Description: Nombre del Auto Scaling Group
    Value: !Ref WebServerAutoScalingGroup

  InitialServerInstanceId:
    Description: ID de la instancia inicial (para crear AMI)
    Value: !Ref InitialWebServer

  BackupLambdaFunctionName:
    Description: Nombre de la funci√≥n Lambda de backups
    Value: !Ref BackupLambdaFunction

  BackupSchedule:
    Description: Programaci√≥n de backups autom√°ticos
    Value: Diario a las 3:00 AM UTC (cron 0 3 * * ? *)

  CertificateArn:
    Description: ARN del certificado SSL/TLS
    Value: !Ref SSLCertificate

  SSLValidationInstructions:
    Description: Pasos para validar SSL
    Value: "1) Ve a AWS Console > Certificate Manager. 2) Copia los registros CNAME. 3) A√±√°delos en tu DNS."

  WAFWebACLArn:
    Description: ARN del WAF Web ACL
    Value: !GetAtt WAFWebACL.Arn

  AdminIPSetArn:
    Description: ARN del IP Set para wp-admin (editable en AWS WAF Console)
    Value: !GetAtt AdminIPSet.Arn

  AdminWhitelistInfo:
    Description: Informaci√≥n sobre protecci√≥n de wp-admin
    Value: !Sub 'Solo las IPs en AdminWhitelistIPs (${AWS::StackName}-AdminWhitelist) pueden acceder a /wp-admin'

  HTTPSLoadBalancerURL:
    Description: URL HTTPS del ALB (despu√©s de validar certificado)
    Value: !Sub 'https://${ApplicationLoadBalancer.DNSName}'

  WordPressURL:
    Description: URL de WordPress via ALB
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}/'

  Health2YouURL:
    Description: URL de la aplicaci√≥n Health2You
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}/wp-content/themes/health2you/'

  CurrentAMIMode:
    Description: Modo actual de AMI
    Value: !If
      - UseProductionAMICondition
      - 'PRODUCCI√ìN (AMI personalizada)'
      - 'BASE (Ubuntu + instalaci√≥n autom√°tica)'

  DatabaseInfo:
    Description: Informaci√≥n de bases de datos creadas
    Value: 'wordpress (WordPress CMS) + health2you (aplicaci√≥n Health2You)'

  MonitoringSNSTopicArn:
    Description: "ARN del SNS Topic para monitoreo"
    Value: !Ref MonitoringSNSTopic
    Export:
      Name: !Sub "${AWS::StackName}-MonitoringSNSTopicArn"

  MonitoringEmailStatus:
    Description: Estado de las notificaciones por email
    Value: !If
      - CreateMonitoringNotifications
      - !Sub 'Email configurado: ${MonitoringEmail}. IMPORTANTE: Revisa tu email y confirma la suscripci√≥n.'
      - 'Email no configurado. Los reportes se guardar√°n en /tmp/ del Bastion.'

  MonitoringInstructions:
    Description: Instrucciones para acceder a los reportes
    Value: !If
      - CreateMonitoringNotifications
      - 'Los reportes se env√≠an autom√°ticamente por email cada 6 horas y diariamente a las 8:00 AM'
      - 'Con√©ctate al Bastion y ejecuta: ls /tmp/wordpress-report-*.html'

  DeploymentSummary:
    Description: Resumen del despliegue
    Value: !Sub
      - |
        ‚úÖ INFRAESTRUCTURA COMPLETA DESPLEGADA
        üîπ RDS Proxy: ${ProxyStatus}
        üîπ WAF IP Whitelist: Activado para /wp-admin
        üîπ Auto Scaling: 2-6 instancias (actual: 3)
        üîπ Backups autom√°ticos: Diarios 3:00 AM UTC
        üîπ EFS: Almacenamiento compartido
        üîπ SSL: Pendiente validaci√≥n DNS
        üåê Accede a: http://${ApplicationLoadBalancer.DNSName}
        üîê Configura tu IP en AdminWhitelistIPs para acceder a wp-admin
      - ProxyStatus: !If
          - EnableRDSProxyCondition
          - 'ACTIVADO ‚úÖ'
          - 'DESACTIVADO ‚ùå'
