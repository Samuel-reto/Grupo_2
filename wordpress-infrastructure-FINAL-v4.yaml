AWSTemplateFormatVersion: '2010-09-09'
Description: 'Infraestructura WordPress con EC2, RDS, S3, NAT Gateway y CloudWatch Logs - AWS Academy Compatible'

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: vockey
    Description: Clave SSH para acceso a instancias

  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Contraseña para RDS PostgreSQL (minimo 8 caracteres)
    Default: WordpressDB2026

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id
    Description: AMI Ubuntu 22.04 LTS

Resources:
  # ============================================
  # CLOUDWATCH LOG GROUP
  # ============================================
  EC2LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ec2/wordpress-instances
      RetentionInDays: 7

  # ============================================
  # VPC Y REDES
  # ============================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: WordPress-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: WordPress-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets Públicas
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-2

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-Subnet-3

  # Subnets Privadas
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.5.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-2

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.6.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: Private-Subnet-3

  # NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: NAT-Gateway-EIP

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: WordPress-NAT-Gateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Public-Route-Table

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  # Route Table PRIVADA
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Private-Route-Table

  PrivateRoute:
    Type: AWS::EC2::Route
    DependsOn: NATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable

  # ============================================
  # SECURITY GROUPS
  # ============================================
  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Bastion-SG
      GroupDescription: Security group for Bastion Host
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH from anywhere
      Tags:
        - Key: Name
          Value: Bastion-SG

  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: WebServer-SG
      GroupDescription: Security group for WordPress web servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from Internet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: SSH from Bastion
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: WebServer-SG

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: RDS-SG
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: PostgreSQL from Web Servers
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: PostgreSQL from Bastion
      Tags:
        - Key: Name
          Value: RDS-SG

  # ============================================
  # S3 BUCKETS
  # ============================================
  WordPressUploadsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'wordpress-uploads-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      Tags:
        - Key: Name
          Value: WordPress-Uploads

  WordPressUploadsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WordPressUploadsBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub '${WordPressUploadsBucket.Arn}/*'

  BackupBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'wordpress-backups-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldBackups
            Status: Enabled
            ExpirationInDays: 30
      Tags:
        - Key: Name
          Value: WordPress-Backups

  # ============================================
  # RDS POSTGRESQL - AUTO VERSION
  # ============================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: wordpress-db-subnet-group
      DBSubnetGroupDescription: Subnet group for RDS in private subnets
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      Tags:
        - Key: Name
          Value: WordPress-DB-Subnet-Group

  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: wordpress-db
      DBName: wordpress
      Engine: postgres
      EngineVersion: '17'
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      StorageType: gp2
      MasterUsername: postgres
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: WordPress-RDS

  # ============================================
  # BASTION HOST
  # ============================================
  BastionInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !Ref PublicSubnet1
          GroupSet:
            - !Ref BastionSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          apt-get update
          apt-get install -y postgresql-client
          echo "Bastion configured" > /tmp/bastion-ready.txt
      Tags:
        - Key: Name
          Value: Bastion-Host

  # ============================================
  # EC2 WORDPRESS INSTANCES
  # ============================================
  WebServer1:
    Type: AWS::EC2::Instance
    DependsOn: 
      - RDSInstance
      - NATGateway
      - EC2LogGroup
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet1
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          LOG_GROUP="/ec2/wordpress-instances"
          REGION="${AWS::Region}"

          echo "=== Starting WordPress Server 1 ==="

          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "OK Internet connectivity"
          else
            echo "ERROR No Internet"
            exit 1
          fi

          apt-get update -y
          apt-get upgrade -y

          snap install amazon-ssm-agent --classic || true
          systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
          systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

          apt-get install -y apache2 php php-pgsql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip postgresql-client awscli

          wget https://amazoncloudwatch-agent.s3.amazonaws.com/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb

          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOF
          {
            "agent": {"region": "$REGION"},
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {"file_path": "/var/log/syslog", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-syslog", "timezone": "UTC"},
                    {"file_path": "/var/log/apache2/error.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-apache-error", "timezone": "UTC"},
                    {"file_path": "/var/log/apache2/access.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-apache-access", "timezone": "UTC"},
                    {"file_path": "/var/log/user-data.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-userdata", "timezone": "UTC"}
                  ]
                }
              }
            }
          }
          EOF

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
          systemctl enable amazon-cloudwatch-agent
          systemctl restart amazon-cloudwatch-agent

          systemctl enable apache2
          systemctl start apache2

          cd /tmp
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          cp -r wordpress/* /var/www/html/
          rm -f /var/www/html/index.html

          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html

          sleep 60

          cd /var/www/html
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/postgres/" wp-config.php
          sed -i "s/password_here/${DBPassword}/" wp-config.php
          sed -i "s/localhost/${RDSInstance.Endpoint.Address}/" wp-config.php

          cat >> wp-config.php << 'EOFCONFIG'

          define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
          define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
          define('AS3CF_REGION', '${AWS::Region}');

          EOFCONFIG

          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          mv wp-cli.phar /usr/local/bin/wp

          cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
          <VirtualHost *:80>
              ServerAdmin webmaster@localhost
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  Options FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              ErrorLog ${!APACHE_LOG_DIR}/error.log
              CustomLog ${!APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
          EOFAPACHE

          a2ensite wordpress
          a2enmod rewrite
          systemctl restart apache2

          echo "=== WordPress Server 1 ready ==="
      Tags:
        - Key: Name
          Value: WordPress-Server-1

  WebServer2:
    Type: AWS::EC2::Instance
    DependsOn:
      - RDSInstance
      - NATGateway
      - EC2LogGroup
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          LOG_GROUP="/ec2/wordpress-instances"
          REGION="${AWS::Region}"

          echo "=== Starting WordPress Server 2 ==="

          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "OK Internet connectivity"
          else
            echo "ERROR No Internet"
            exit 1
          fi

          apt-get update -y
          apt-get upgrade -y

          snap install amazon-ssm-agent --classic || true
          systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
          systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

          apt-get install -y apache2 php php-pgsql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip postgresql-client awscli

          wget https://amazoncloudwatch-agent.s3.amazonaws.com/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb

          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOF
          {
            "agent": {"region": "$REGION"},
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {"file_path": "/var/log/syslog", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-syslog", "timezone": "UTC"},
                    {"file_path": "/var/log/apache2/error.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-apache-error", "timezone": "UTC"},
                    {"file_path": "/var/log/apache2/access.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-apache-access", "timezone": "UTC"},
                    {"file_path": "/var/log/user-data.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-userdata", "timezone": "UTC"}
                  ]
                }
              }
            }
          }
          EOF

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
          systemctl enable amazon-cloudwatch-agent
          systemctl restart amazon-cloudwatch-agent

          systemctl enable apache2
          systemctl start apache2

          cd /tmp
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          cp -r wordpress/* /var/www/html/
          rm -f /var/www/html/index.html

          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html

          sleep 60

          cd /var/www/html
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/postgres/" wp-config.php
          sed -i "s/password_here/${DBPassword}/" wp-config.php
          sed -i "s/localhost/${RDSInstance.Endpoint.Address}/" wp-config.php

          cat >> wp-config.php << 'EOFCONFIG'

          define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
          define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
          define('AS3CF_REGION', '${AWS::Region}');

          EOFCONFIG

          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          mv wp-cli.phar /usr/local/bin/wp

          cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
          <VirtualHost *:80>
              ServerAdmin webmaster@localhost
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  Options FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              ErrorLog ${!APACHE_LOG_DIR}/error.log
              CustomLog ${!APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
          EOFAPACHE

          a2ensite wordpress
          a2enmod rewrite
          systemctl restart apache2

          echo "=== WordPress Server 2 ready ==="
      Tags:
        - Key: Name
          Value: WordPress-Server-2

  WebServer3:
    Type: AWS::EC2::Instance
    DependsOn:
      - RDSInstance
      - NATGateway
      - EC2LogGroup
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      IamInstanceProfile: LabInstanceProfile
      SubnetId: !Ref PrivateSubnet3
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log)
          exec 2>&1

          LOG_GROUP="/ec2/wordpress-instances"
          REGION="${AWS::Region}"

          echo "=== Starting WordPress Server 3 ==="

          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "OK Internet connectivity"
          else
            echo "ERROR No Internet"
            exit 1
          fi

          apt-get update -y
          apt-get upgrade -y

          snap install amazon-ssm-agent --classic || true
          systemctl enable snap.amazon-ssm-agent.amazon-ssm-agent.service
          systemctl start snap.amazon-ssm-agent.amazon-ssm-agent.service

          apt-get install -y apache2 php php-pgsql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip wget unzip postgresql-client awscli

          wget https://amazoncloudwatch-agent.s3.amazonaws.com/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb

          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOF
          {
            "agent": {"region": "$REGION"},
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {"file_path": "/var/log/syslog", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-syslog", "timezone": "UTC"},
                    {"file_path": "/var/log/apache2/error.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-apache-error", "timezone": "UTC"},
                    {"file_path": "/var/log/apache2/access.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-apache-access", "timezone": "UTC"},
                    {"file_path": "/var/log/user-data.log", "log_group_name": "$LOG_GROUP", "log_stream_name": "{instance_id}-userdata", "timezone": "UTC"}
                  ]
                }
              }
            }
          }
          EOF

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
          systemctl enable amazon-cloudwatch-agent
          systemctl restart amazon-cloudwatch-agent

          systemctl enable apache2
          systemctl start apache2

          cd /tmp
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          cp -r wordpress/* /var/www/html/
          rm -f /var/www/html/index.html

          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html

          sleep 60

          cd /var/www/html
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/postgres/" wp-config.php
          sed -i "s/password_here/${DBPassword}/" wp-config.php
          sed -i "s/localhost/${RDSInstance.Endpoint.Address}/" wp-config.php

          cat >> wp-config.php << 'EOFCONFIG'

          define('AS3CF_AWS_USE_EC2_IAM_ROLE', true);
          define('AS3CF_BUCKET', '${WordPressUploadsBucket}');
          define('AS3CF_REGION', '${AWS::Region}');

          EOFCONFIG

          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          mv wp-cli.phar /usr/local/bin/wp

          cat > /etc/apache2/sites-available/wordpress.conf << 'EOFAPACHE'
          <VirtualHost *:80>
              ServerAdmin webmaster@localhost
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  Options FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              ErrorLog ${!APACHE_LOG_DIR}/error.log
              CustomLog ${!APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
          EOFAPACHE

          a2ensite wordpress
          a2enmod rewrite
          systemctl restart apache2

          echo "=== WordPress Server 3 ready ==="
      Tags:
        - Key: Name
          Value: WordPress-Server-3

# ============================================
# OUTPUTS
# ============================================
Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC

  NATGatewayIP:
    Description: NAT Gateway Elastic IP
    Value: !Ref NATGatewayEIP

  CloudWatchLogGroup:
    Description: CloudWatch Log Group
    Value: !Ref EC2LogGroup

  PublicSubnets:
    Description: Public Subnet IDs for ALB
    Value: !Sub '${PublicSubnet1},${PublicSubnet2},${PublicSubnet3}'

  BastionPublicIP:
    Description: Bastion Host Public IP
    Value: !GetAtt BastionInstance.PublicIp

  RDSEndpoint:
    Description: RDS Database Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address

  WordPressUploadsBucketName:
    Description: S3 Bucket for WordPress uploads
    Value: !Ref WordPressUploadsBucket

  BackupBucketName:
    Description: S3 Bucket for backups
    Value: !Ref BackupBucket

  WebServer1PrivateIP:
    Description: Web Server 1 Private IP
    Value: !GetAtt WebServer1.PrivateIp

  WebServer2PrivateIP:
    Description: Web Server 2 Private IP
    Value: !GetAtt WebServer2.PrivateIp

  WebServer3PrivateIP:
    Description: Web Server 3 Private IP
    Value: !GetAtt WebServer3.PrivateIp

  WebServerSecurityGroup:
    Description: Web Server Security Group ID
    Value: !Ref WebServerSecurityGroup
